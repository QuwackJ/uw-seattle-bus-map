<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <title>UW Seattle Bus Map</title>
    <link rel="icon" type="image/x-icon" href="favicon/favicon.ico">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <link href="https://api.mapbox.com/mapbox-gl-js/v3.16.0/mapbox-gl.css" rel="stylesheet">
    <script src="https://api.mapbox.com/mapbox-gl-js/v3.16.0/mapbox-gl.js"></script>

    <style>
        body { 
            margin:0; 
            padding:0;
            display:flex;
            font-family: sans-serif;
        }

        #menu {
            width: 280px;
            height: 100vh;
            background: white;
            padding: 20px;
            border-right: 2px solid #ddd;
            box-sizing: border-box;
            overflow-y: auto;
        }

        #menu h2 {
            margin-top: 0;
            font-size: 24px;
            font-weight: 700;
        }

        .route-btn {
            background-color: var(--route-color);
            width: 100%;
            padding: 10px 14px;
            margin-bottom: 10px;
            font-size: 16px;
            border-radius: 6px;
            border: 1.5px solid #000;
            cursor: pointer;
            text-align: left;
        }

        .route-btn.active {
            border-color: #007aff;
            box-shadow: 0 0 0 2px rgba(0,122,255,0.15);
        }

        .route-btn.disabled,
        .route-btn[disabled] {
            background-color: #cccccc !important;
            color: #666666 !important;
            cursor: not-allowed;
        }

        #map { 
            flex-grow: 1;
            height: 100vh;
        }
    </style>
</head>

<body>

    <div id="menu">
        <h2>Bus Routes</h2>
        <p style="font-size:12px; margin-top:8px; color:#555;">
            Click a route to highlight it. Click again to reset.
        </p>
        <button class="route-btn" data-route-id="100223" style="--route-color: #EB2A22;">Route 43</button>
        <button class="route-btn" data-route-id="100224" style="--route-color: #3E6ECF;">Route 44</button>
        <button class="route-btn" data-route-id="100225" style="--route-color: #4DBA4A;">Route 45</button>
        <button class="route-btn" data-route-id="100228" style="--route-color: #984EBD;">Route 48</button>
        <button class="route-btn" data-route-id="100447" style="--route-color: #FF6B00;">Route 49</button>
        <button class="route-btn" data-route-id="100254" style="--route-color: #FFBD3D;">Route 65</button>
        <button class="route-btn" data-route-id="100259" style="--route-color: #46D2CD;">Route 67</button>
        <button class="route-btn" data-route-id="100264" style="--route-color: #FB3BA6;">Route 70</button>
    </div>

    <div id="map"></div>
    
    <script type="module">
        // importing function to fetch data from API, convert to object, and convert to GeoJSON
        import { getLiveBusGeoJSON } from './live_bus_positions.js';

        // importing function to fade bus stops that are not on selected route
        import { menuLogic } from './menu_logic.js';

        mapboxgl.accessToken = 'pk.eyJ1IjoicGFpc2xleXc4MjkiLCJhIjoiY21oZTY4Z3h6MGFpbzJsb2UzbWkxZjZybyJ9.qvAAm5rLQZPLPn8ltX2vLg';
        
        const map = new mapboxgl.Map({
            container: 'map',
            style: 'mapbox://styles/mapbox/light-v11', 
            center: [-122.3035, 47.6553], 
            zoom: 12,
        });

        async function makeMap() {
            map.on('load', () => {
                const layers = map.getStyle().layers;
                const labelLayerId = layers.find(
                    (layer) => layer.type === 'symbol' && layer.layout['text-field']
                ).id;
                
                map.addLayer({
                    'id': '3d-buildings',
                    'source': 'composite',
                    'source-layer': 'building',
                    'filter': ['==', 'extrude', 'true'],
                    'type': 'fill-extrusion',
                    'minzoom': 15,
                    'paint': {
                        'fill-extrusion-color': '#aaa',
                        'fill-extrusion-height': ['get', 'height'],
                        'fill-extrusion-base': ['get', 'min_height'],
                        'fill-extrusion-opacity': 0.85
                    }
                }, labelLayerId);

                map.addSource('uw-routes', {
                    type: 'geojson',
                    data: 'assets/routes_uw.geojson'
                });

                map.addLayer({
                    'id': 'uw-route-lines',
                    'type': 'line',
                    'source': 'uw-routes',
                    'layout': {
                        'line-join': 'round',
                        'line-cap': 'round'
                    },
                    'paint': {
                        'line-width': 3,
                        'line-color': '#53585C',        
                    }
                });

                // add stop points 
                map.addSource('uw-stops', {
                    type: 'geojson',
                    data: 'assets/stops_uw.geojson'
                });

                map.addLayer({
                    'id': 'uw-stops',
                    'type': 'circle',
                    'source': 'uw-stops',
                    'minzoom': 14,
                    'paint': {
                        'circle-radius': 5,
                        'circle-color': '#6C7278',
                        'circle-stroke-width': 1,
                        'circle-stroke-color': '#fff'
                    }
                });

                // setting up menu logic from external module
                menuLogic(map);

                // add pop-ups for stops
                map.on('click', 'uw-stops', (e) => {
                    const feature = e.features[0];
                    const coordinates = feature.geometry.coordinates.slice();
                    const props = feature.properties;

                    const description = `
                        <b>Stop Address:</b> ${props.stop_name}
                    `;

                    new mapboxgl.Popup()
                        .setLngLat(coordinates)
                        .setHTML(description)
                        .addTo(map);
                });

                // add live bus positions
                // first add empty source and layer
                map.addSource('live-buses', {
                    type: 'geojson',
                    data: {"type": "FeatureCollection", "features": []}
                });

                // styling for bus positions based on route_num
                map.addLayer({
                    'id': 'live-bus-positions',
                    'type': 'circle',
                    'source': 'live-buses',
                    'paint': {
                        'circle-radius': 6,
                        'circle-stroke-width': 1.5,
                        'circle-stroke-color': '#000000',
                        'circle-color': [
                            'match',
                            ['get', 'route_num'],
                            '43', '#EB2A22',
                            '44', '#3E6ECF',
                            '45', '#4DBA4A',
                            '48', '#984EBD',
                            '49', '#FF6B00',
                            '65', '#FFBD3D',
                            '67', '#46D2CD',
                            '70', '#FB3BA6',
                            '#AAAAAA' // default color for other routes
                        ]
                    }
                });

                // tracking active pop-up and bus associated with it
                let activeBusPopup = null;
                let activeBusLabel = null;

                // add pop-ups for live bus positions
                map.on('click', 'live-bus-positions', (e) => {
                    const feature = e.features[0];
                    const props = feature.properties;
                    const coords = feature.geometry.coordinates.slice();

                    // remembering which bus we're tracking
                    activeBusLabel = props.label;

                    // if a pop-up already exists, remove it
                    if (activeBusPopup) {
                        activeBusPopup.remove();
                    }

                    const popupContent = `
                        <strong>Route #:</strong> ${props.route_num} <br>
                        <strong>Headsign:</strong> ${props.headsign_primary} <br>
                        ${
                            props.headsign_secondary 
                            ? `<strong>Secondary Headsign:</strong> ${props.headsign_secondary} <br>` 
                            : ""
                        }
                        <strong>Label:</strong> ${props.label} <br>
                    `;

                    activeBusPopup = new mapboxgl.Popup({closeOnClick: false})
                        .setLngLat([coords[0], coords[1]])
                        .setHTML(popupContent)
                        .addTo(map);
                });

                // function to update live bus positions the first time and every few seconds
                async function updateBusPositions() {
                    const busGeoJSON = await getLiveBusGeoJSON();
                    map.getSource('live-buses').setData(busGeoJSON);

                    // move pop-up with bus if it's open
                    if (activeBusPopup && activeBusLabel) {
                        // find feature for bus we're tracking
                        const busFeature = busGeoJSON.features.find(
                            f => f.properties.label === activeBusLabel
                        );

                        if (busFeature) {
                            const newCoords = busFeature.geometry.coordinates;
                            activeBusPopup.setLngLat(newCoords);
                        } else {
                            // bus is no longer active, remove pop-up
                            activeBusPopup.remove();
                            activeBusPopup = null;
                            activeBusLabel = null;
                        }
                    }
                }

                // first load of bus positions
                updateBusPositions();

                // updating every 7.5 seconds
                const POLLING_INTERVAL = 7500;
                setInterval(updateBusPositions, POLLING_INTERVAL);

                // setting up route selection buttons
                const routeColors = {
                    "43": "#EB2A22", // red
                    "44": "#3E6ECF", // blue
                    "45": "#4DBA4A", // green
                    "48": "#984EBD", // purple
                    "49": "#FF6B00", // orange
                    "65": "#FFBD3D", // yellow
                    "67": "#46D2CD", // teal 
                    "70": "#FB3BA6"  // pink
                };

                let currentSelectedRoute = null;

                function setRouteStyle(routeNameOrNull) {
                    if (!routeNameOrNull) {
                        map.setPaintProperty('uw-route-lines', 'line-color', '#53585C');
                        map.setPaintProperty('uw-route-lines', 'line-opacity', 1);
                    } else {
                        const routeColor = routeColors[routeNameOrNull] || '#ff6600';

                        map.setPaintProperty('uw-route-lines', 'line-color', [
                            'case',
                            ['==', ['to-string', ['get', 'route_name']], routeNameOrNull],
                            routeColor,
                            '#53585C'
                        ]);

                        map.setPaintProperty('uw-route-lines', 'line-opacity', [
                            'case',
                            ['==', ['to-string', ['get', 'route_name']], routeNameOrNull],
                            1,    
                            0.04  
                        ]);
                    }
                }

                function setupRouteButtons() {
                    const buttons = document.querySelectorAll('.route-btn');

                    buttons.forEach(btn => {
                        btn.addEventListener('click', () => {
                            const routeText = btn.textContent.trim(); 
                            const routeName = routeText.replace('Route ', ''); 

                            // if the same button has been clicked again, enable all buttons
                            if (currentSelectedRoute === routeName) {
                                currentSelectedRoute = null;
                                setRouteStyle(null);
                                buttons.forEach(b => {
                                    b.classList.remove('disabled');
                                    b.disabled = false;
                                    b.removeAttribute('aria-disabled'); // for accessibility
                                });
                                return;
                            }

                            currentSelectedRoute = routeName;
                            setRouteStyle(routeName);

                            buttons.forEach(b => {
                                if (b === btn) {
                                    b.classList.add('active');
                                    b.classList.remove('disabled');
                                    b.disabled = false;
                                    b.removeAttribute('aria-disabled'); // for accessibility
                                } else {
                                    b.classList.remove('active');
                                    b.classList.add('disabled');
                                    b.disabled = true;
                                    b.setAttribute('aria-disabled', 'true'); // for accessibility
                                }
                            });
                        });
                    });
                }

                setupRouteButtons();
            });
        }

        makeMap();
    </script>
</body>
</html>
