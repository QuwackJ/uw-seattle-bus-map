<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <title>Seattle Bus Map</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <link href="https://api.mapbox.com/mapbox-gl-js/v3.14.0/mapbox-gl.css" rel="stylesheet">
    <script src="https://api.mapbox.com/mapbox-gl-js/v3.14.0/mapbox-gl.js"></script>

    <style>
        body { 
            margin:0; 
            padding:0;
        }

        #map { 
            position:absolute; 
            top:0; 
            bottom:0; 
            width:100%;
        }

        #menu { 
            position:absolute; 
            background:white; 
            padding:10px; 
            top:10px; 
            left:10px; 
            z-index:1; 
            border-radius:8px;
        }
    </style>
</head>

<body>
    <div id="menu"></div>
    <div id="map"></div>
    
    <script type="module">
        // importing static data objects (routes and stops)
        // import { routes_uw } from './assets/routes_uw.js';
        // import { stops_uw } from './assets/stops_uw.js';

        // importing function to fetch data from API, convert to object, and convert to GeoJSON
        import { getLiveBusGeoJSON } from './live_bus_positions.js';

        // setting up map and basemap style
        mapboxgl.accessToken = 'pk.eyJ1IjoicGFpc2xleXc4MjkiLCJhIjoiY21oZTY4Z3h6MGFpbzJsb2UzbWkxZjZybyJ9.qvAAm5rLQZPLPn8ltX2vLg';
        
        const map = new mapboxgl.Map({
            container: 'map',
            style: 'mapbox://styles/mapbox/light-v11', 
            center: [-122.3035, 47.6553], 
            zoom: 12,
        });

        // function to add layers to map
        async function makeMap() {
            // adding layers
            map.on('load', () => {
                const layers = map.getStyle().layers;
                const labelLayerId = layers.find(
                    (layer) => layer.type === 'symbol' && layer.layout['text-field']
                ).id;
                
                // add 3D buildings
                map.addLayer({
                    'id': '3d-buildings',
                    'source': 'composite',
                    'source-layer': 'building',
                    'filter': ['==', 'extrude', 'true'],
                    'type': 'fill-extrusion',
                    'minzoom': 15,
                    'paint': {
                        'fill-extrusion-color': '#aaa',
                        'fill-extrusion-height': ['get', 'height'],
                        'fill-extrusion-base': ['get', 'min_height'],
                        'fill-extrusion-opacity': 0.85
                    }
                }, labelLayerId);

                // add route lines
                map.addSource('uw-routes', {
                    type: 'geojson',
                    data: 'assets/routes_uw.geojson'
                });

                map.addLayer({
                    'id': 'uw-route-lines',
                    'type': 'line',
                    'source': 'uw-routes',
                    'layout': {
                        'line-join': 'round',
                        'line-cap': 'round'
                    },
                    'paint': {
                        'line-color': '#53585C', // default color when user hasn't selected a route from menu
                        'line-width': 3
                    }
                });

                // add stop points
                map.addSource('uw-stops', {
                    type: 'geojson',
                    data: 'assets/stops_uw.geojson'
                });

                map.addLayer({
                    'id': 'uw-stops',
                    'type': 'circle',
                    'source': 'uw-stops',
                    'minzoom': 14,
                    'paint': {
                        'circle-radius': 5,
                        'circle-color': '#6C7278', // default color when user hasn't selected a route from menu
                        'circle-stroke-width': 1,
                        'circle-stroke-color': '#fff'
                    }
                });

                // add pop-ups for stops
                map.on('click', 'uw-stops', (e) => {
                    const feature = e.features[0];
                    const coordinates = feature.geometry.coordinates.slice();
                    const props = feature.properties;

                    const description = `
                        <b>Stop Address:</b> ${p.stop_name}
                    `;

                    new mapboxgl.Popup()
                        .setLngLat(coordinates)
                        .setHTML(description)
                        .addTo(map);
                });

                // add live bus positions
                // first add empty source and layer
                map.addSource('live-buses', {
                    type: 'geojson',
                    data: {"type": "FeatureCollection", "features": []}
                });

                // styling for bus positions
                map.addLayer({
                    'id': 'live-bus-positions',
                    'type': 'circle',
                    'source': 'live-buses',
                    'paint': {
                        'circle-radius': 6,
                        'circle-color': '#EB1B00',
                        'circle-stroke-width': 1,
                        'circle-stroke-color': '#fff'
                    }
                });

                // function to update live bus positions the first time and every few seconds
                async function updateBusPositions() {
                    const busGeoJSON = await getLiveBusGeoJSON();
                    map.getSource('live-buses').setData(busGeoJSON);
                }

                // first call
                updateBusPositions();

                // updating every 
                const POLLING_INTERVAL = 7500; //  (in milliseconds)
                setInterval(updateBusPositions, POLLING_INTERVAL);
            });
        }

        makeMap();
    </script>
</body>
</html>
